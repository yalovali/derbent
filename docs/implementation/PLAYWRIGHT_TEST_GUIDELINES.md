# Playwright Test Guidelines

The Playwright-based regression suite under `src/test/java/automated_tests/tech/derbent/ui/automation` follows a shared set of patterns to keep
multi-tenant UI automation predictable and maintainable. Follow the practices below whenever you create or update a Playwright test class.

## Core Principles

- **Extend `CBaseUITest`** to inherit the deterministic login, navigation, project-context helpers, and Playwright session lifecycle management.
- **Prefer ID-based selectors** generated by `CFormBuilder`. Use `computeFieldId(Class<?>, String)` or convenience helpers such as
  `fillFieldById(Class<?>, String, String)` and `selectFirstComboBoxOptionById(Class<?>, String)` instead of query selectors that rely on labels,
  ordering, or Vaadin internals.
- **Keep CRUD flows symmetric**: ensure every create action is followed by an update and delete within the same test to leave the test database in a
  clean state. Capture the initial and final grid row counts to detect leaks.
- **Generate stable data** using timestamps or UUID suffixes (`LocalDateTime` + `DateTimeFormatter`) so that repeated executions do not collide with
  existing H2 fixtures.

## Screenshot Conventions

- **Always capture a success _and_ failure screenshot** per significant scenario. Use `takeViewScreenshot(viewClass, scenario, success)` so filenames
  are derived from the viewâ€™s `VIEW_NAME` or `@Route` metadata and end with `-success` / `-failure`.
- **Group scenarios by behavior**, e.g. `crud-create`, `crud-update`, `crud-delete`, `initial-state`, and `crud-error`. Reuse the same scenario keys
  across tests so screenshot comparisons remain meaningful.
- **Avoid ad-hoc screenshot names**; rely on the helper to keep `target/screenshots/` tidy and suitable for Playwright evidence uploads.

## Field Interaction Rules

- **Populate all required fields explicitly** during create/update flows. If the form depends on ComboBoxes, call
  `selectFirstComboBoxOptionById` (or implement a specific chooser) to avoid brittle text-based selectors.
- **Assert form results** using `readFieldValueById` / `assertFieldValueEquals` before and after `clickSave()` so regressions are caught before a
  delete runs.
- **Use grid verifications** (`vaadin-grid-cell-content` with `Locator.FilterOptions().setHasText(...)`) after each CRUD step. Always fail fast if
  the expected value is missing to surface data-binding issues.

## Navigation & Timing

- **Use dedicated navigation helpers**, e.g. `page.navigate("http://localhost:" + port + "/{route}")` followed by `waitForDynamicPageLoad()` to
  guarantee Vaadin finished rendering before interacting with forms.
- **Favor semantic waits** (`wait_500`, `wait_1000`, `waitForDynamicPageLoad`) instead of `Thread.sleep`. These utilities already integrate with the
  Playwright page instance.

## Adding New Suites

- **Update `run-playwright-tests.sh`** whenever a new test suite is introduced so CI and local developers can execute it via `./run-playwright-tests.sh`.
- **Keep test class names C-prefixed** (`CCrudRegressionTest`) and end with `Test` to align with the Maven Surefire discovery settings.
- **Document unique patterns** alongside the test class (e.g., custom selectors, prerequisite data) via code comments or a companion section in this
  document when the use case is not obvious.

These guidelines ensure the automation suite remains deterministic, diagnosable, and easy to extend as new Vaadin screens are introduced.
