# Derbent Project - Cursor IDE Rules

## ü§ñ AI ASSISTANT OPERATING MODE (AUTONOMOUS PERMISSIONS)

**The AI assistant operates in AUTONOMOUS MODE with the following permissions:**

### ‚úÖ ALWAYS Proceed WITHOUT Confirmation For:
- File modifications (create, edit, delete files)
- Code refactoring and improvements
- Running builds, tests, and validation (`mvn clean compile`, `./run-playwright-tests.sh`)
- Applying code formatting (via eclipse-formatter.xml in IDE)
- Taking screenshots for documentation
- Committing changes to git with descriptive messages
- Installing dependencies or tools when needed
- Running Playwright tests after UI changes
- Fixing compilation errors
- Updating documentation related to code changes

### ‚ùå ONLY Ask for Confirmation When:
- Deleting entire directories or multiple files at once
- Making breaking changes to public APIs
- Modifying production configuration files
- Pushing to remote git repository
- Making database schema changes in production mode
- Major architectural decisions that affect multiple modules

### üìã Standard Workflow After Completing Tasks:
**AUTOMATICALLY execute this workflow (no permission needed):**
1. Apply code formatting via IDE (eclipse-formatter.xml)
2. Run `mvn clean compile` (if code changes made)
3. Run appropriate Playwright tests (if UI changes made)
4. Stage and commit changes with conventional commit message
5. Provide brief summary of what was done

### üí¨ Communication Style:
- Be concise - provide essential information without over-explaining
- Use action-oriented language: "Running tests...", "Applying formatting...", "Committing changes..."
- Report progress for long-running operations
- Highlight critical issues that need attention
- Summarize results at end of operations

### üéØ Git Commit Standards (AUTO-COMMIT):
- ALWAYS commit completed work without asking
- Use conventional commit format: `feat:`, `fix:`, `refactor:`, `test:`, `docs:`, `chore:`
- Include detailed description of changes
- Include usage examples for new features
- Stage only related files (don't commit unrelated changes)

---

## Project Overview
Derbent is a Java 21 Spring Boot + Vaadin 24.8 project management application.

## üéØ PRIMARY DOCUMENTATION (MANDATORY - READ FIRST)

**‚≠ê SINGLE SOURCE OF TRUTH:**
```
docs/DERBENT_CODING_MASTER_GUIDE.md
```
**THIS IS THE AUTHORITATIVE REFERENCE. READ IT BEFORE ANY CODE CHANGES.**

### Quick Reference by Task

**For New Entity Implementation:**
1. `docs/DERBENT_CODING_MASTER_GUIDE.md` Section 2 (Entity Implementation Guide)
2. `docs/architecture/NEW_ENTITY_COMPLETE_CHECKLIST.md` (176 checkboxes)
3. `docs/architecture/ENTITY_INHERITANCE_AND_DESIGN_PATTERNS.md` (detailed patterns)

**For Repository/Query Work:**
- `docs/DERBENT_CODING_MASTER_GUIDE.md` Section 5 (Repository & Query Patterns)
- **CRITICAL**: All findById() MUST include JOIN FETCH for attachments/comments

**For Service Layer:**
- `docs/DERBENT_CODING_MASTER_GUIDE.md` Section 6 (Service Layer Patterns)
- **CRITICAL**: Services MUST be stateless (multi-user)

**For UI Components:**
- `docs/DERBENT_CODING_MASTER_GUIDE.md` Section 7 (UI Component Standards)
- `docs/development/component-coding-standards.md` (detailed component patterns)

**For Testing:**
- `docs/DERBENT_CODING_MASTER_GUIDE.md` Section 9 (Testing Guidelines)
- `docs/testing/PLAYWRIGHT_USAGE.md` (Playwright specifics)

**For Common Pitfalls:**
- `docs/DERBENT_CODING_MASTER_GUIDE.md` Section 10 (10 CRITICAL mistakes to avoid)

## Essential Setup
Before coding, ALWAYS run:
```bash
source ./setup-java-env.sh  # Configure Java 21 environment
```

## Coding Standards (MANDATORY)

### 1. C-Prefix Convention
ALL custom classes MUST use "C" prefix:
- ‚úÖ `CActivity`, `CUser`, `CProject`
- ‚úÖ `CActivityService`, `CUserService`
- ‚úÖ `CActivityView`, `CUserPage`
- ‚ùå `Activity`, `User` (WRONG - missing prefix)

Exceptions:
- Interfaces: Use "I" prefix (`IActivityRepository`)
- Tests: Keep C-prefix (`CActivityTest`)

### 2. UI Component Field Naming (typeName Convention - MANDATORY)
ALL UI component fields MUST follow `{type}{Name}` format:
```java
// ‚úÖ CORRECT
private CButton buttonAdd;              // button{Name}
private CButton buttonDelete;           // button{Name}
private CButton buttonMoveUp;           // button{Name}
private CDialog dialogConfirmation;     // dialog{Name}
private CVerticalLayout layoutMain;     // layout{Name}
private CHorizontalLayout layoutToolbar; // layout{Name}
private CGrid<CEntity> gridItems;       // grid{Name}
private ComboBox<String> comboBoxStatus; // comboBox{Name}
private TextField textFieldName;        // textField{Name}

// ‚ùå WRONG - Do NOT use
private CButton addBtn;                 // Wrong!
private CButton btn_delete;             // Wrong!
private Button addButton;               // Wrong! Use CButton buttonAdd
private HorizontalLayout toolbar;       // Wrong! Use CHorizontalLayout layoutToolbar
```

### 3. Event Handler Naming (on_xxx_eventType - MANDATORY)
ALL event handlers MUST follow `on_{componentName}_{eventType}` pattern:
```java
// ‚úÖ CORRECT
protected void on_buttonAdd_clicked() { }
protected void on_buttonDelete_clicked() { }
protected void on_buttonMoveUp_clicked() { }
protected void on_gridItems_selected(CEntity item) { }
protected void on_gridItems_doubleClicked(CEntity item) { }
protected void on_comboBoxStatus_changed(String status) { }

// ‚ùå WRONG - Do NOT use
private void handleAdd() { }            // Wrong!
private void onDeleteClick() { }        // Wrong!
private void processSelection() { }     // Wrong!
```

### 4. Factory Method Naming (create_xxx - MANDATORY)
ALL component factory methods MUST follow `create_{componentName}` pattern:
```java
// ‚úÖ CORRECT
protected CButton create_buttonAdd() {
    final CButton button = new CButton(VaadinIcon.PLUS.create());
    button.addClickListener(e -> on_buttonAdd_clicked());
    return button;
}

protected CButton create_buttonDelete() {
    final CButton button = new CButton(VaadinIcon.TRASH.create());
    button.addClickListener(e -> on_buttonDelete_clicked());
    return button;
}

// ‚ùå WRONG - Do NOT use
protected CButton createAddButton() { }     // Wrong!
protected CButton getDeleteButton() { }     // Wrong!
```

### 5. Never Use Lambda for Complex Logic
ALWAYS delegate to named methods:
```java
// ‚ùå WRONG - Complex lambda (hard to read, hard to override)
buttonAdd.addClickListener(e -> {
    // Long complex logic here...
    doThis();
    doThat();
});

// ‚úÖ CORRECT - Delegate to named method
buttonAdd.addClickListener(e -> on_buttonAdd_clicked());
```

### 6. Always Use C-Prefixed Components
NEVER use raw Vaadin components:
| ‚ùå Wrong | ‚úÖ Correct |
|----------|-----------|
| `Button` | `CButton` |
| `Dialog` | `CDialog` |
| `VerticalLayout` | `CVerticalLayout` |
| `HorizontalLayout` | `CHorizontalLayout` |
| `Grid<T>` | `CGrid<T>` |
| `TextField` | `CTextField` |
| `FormLayout` | `CFormLayout` |

### 7. Package Structure
```
tech.derbent.{module}.{layer}
- module: activities, users, projects, etc.
- layer: domain, service, view
```

Example:
- `tech.derbent.activities.domain.CActivity`
- `tech.derbent.activities.service.CActivityService`
- `tech.derbent.activities.view.CActivityView`

### 8. Inheritance Patterns
Follow established base classes:
- Entities: Extend `CEntityDB<T>`, `CProjectItem<T>`, etc.
- Services: Extend `CAbstractService<T>`
- Views: Extend `CAbstractEntityDBPage<T>`

### 9. Notification System (CRITICAL)
NEVER use direct Vaadin Notification.show(). ALWAYS use:
```java
@Autowired
private CNotificationService notificationService;

notificationService.showSuccess("Operation completed");
notificationService.showError("Operation failed");
notificationService.showSaveSuccess();
notificationService.showDeleteError();
```

For static contexts:
```java
CNotifications.showSuccess("Message");
CNotifications.showError("Message");
```

### 10. Type Safety
Always use generics:
```java
// ‚úÖ Correct
public class CActivity extends CProjectItem<CActivity> {}
List<CActivity> activities = service.findAll();

// ‚ùå Wrong
public class CActivity extends CProjectItem {}  // Raw type
```

## Build Commands

### Compile (15 seconds)
```bash
mvn clean compile
```

### Format Code (REQUIRED before commit)
```bash
mvn spotless:apply
mvn spotless:check
```

### Run Application (H2 database for development)
```bash
mvn spring-boot:run -Dspring.profiles.active=h2
```

### Run Tests
```bash
./run-playwright-tests.sh menu        # UI tests with screenshots
./run-playwright-tests.sh comprehensive # Full test suite
```

## Grid Column Standards (MANDATORY)

### Always Use Entity-Enabled Column Methods

When adding grid columns for entity references (status, assigned user, approved by, etc.), ALWAYS use CGrid's entity column helper methods instead of manual rendering:

```java
// ‚úÖ CORRECT - Use entity column helper methods
grid.addColumnEntityNamed(CActivity::getStatus, "Status");
grid.addColumnEntityNamed(CActivity::getAssignedTo, "Assigned To");
grid.addColumnEntityNamed(CActivity::getApprovedBy, "Approved By");
grid.addColumnEntityCollection(CActivity::getParticipants, "Participants");

// ‚ùå WRONG - Manual rendering
grid.addColumn(a -> a.getStatus() != null ? a.getStatus().getName() : "")
    .setHeader("Status");  // Don't do this!
```

**Available CGrid Entity Column Methods:**
| Method | Use For | Example |
|--------|---------|---------|
| `addColumnEntityNamed()` | Single entity reference (status, user, etc.) | `grid.addColumnEntityNamed(Activity::getStatus, "Status")` |
| `addColumnEntityCollection()` | Collection of entities | `grid.addColumnEntityCollection(Activity::getParticipants, "Participants")` |
| `addEntityColumn()` | Entity with custom rendering (uses CLabelEntity) | `grid.addEntityColumn(Activity::getStatus, "Status", "status", CStatus.class)` |

**Benefits:**
- ‚úÖ Consistent rendering across all grids
- ‚úÖ Automatic null handling
- ‚úÖ Proper lazy loading handling
- ‚úÖ Name extraction from CEntityNamed
- ‚úÖ Collection formatting (comma-separated)
- ‚úÖ Error handling built-in

**Rule**: If a field returns `CEntityDB<?>` or `Collection<? extends CEntityDB<?>>`, use entity column methods.

## Validation Checklist

Before completing any task:
1. ‚úÖ All custom classes have C-prefix
2. ‚úÖ UI fields follow typeName convention (buttonAdd, gridItems, etc.)
3. ‚úÖ Event handlers follow on_xxx_eventType pattern
4. ‚úÖ Factory methods follow create_xxx pattern
5. ‚úÖ No complex lambda - delegates to named methods
6. ‚úÖ Uses C-prefixed components (not raw Vaadin)
7. ‚úÖ No raw types - generics used everywhere
8. ‚úÖ CNotificationService used (not Notification.show)
9. ‚úÖ **Entity columns use helper methods** (addColumnEntityNamed, etc.)
10. ‚úÖ Code formatted with `mvn spotless:apply`
11. ‚úÖ Project compiles: `mvn clean compile`

## Common Mistakes to Avoid
‚ùå Wrong field names (addBtn instead of buttonAdd)
‚ùå Wrong handler names (handleAdd instead of on_buttonAdd_clicked)
‚ùå Complex logic in lambda expressions
‚ùå Using raw Vaadin components (Button instead of CButton)
‚ùå Missing C-prefix on custom classes
‚ùå Direct Notification.show() calls
‚ùå Forgetting to format with spotless

## Entity Design Patterns (2026-01)

### Entity Inheritance Decision Tree
```
Database entity?
‚îú‚îÄ NO ‚Üí POJO or Component
‚îî‚îÄ YES ‚Üí CEntityDB<T>
    ‚îî‚îÄ Named? ‚Üí CEntityNamed<T>
        ‚îú‚îÄ Company-scoped? ‚Üí CEntityOfCompany<T>  // roles, workflows, types
        ‚îî‚îÄ Project-scoped? ‚Üí CEntityOfProject<T>
            ‚îî‚îÄ Work item? ‚Üí CProjectItem<T>  // activities, meetings, decisions
```

### Interface vs Inheritance
- **Inheritance**: Identity, persistence, IS-A relationships
- **Interfaces**: Optional capabilities, behavior contracts

Example:
```java
// ‚úÖ Interface for optional capability
public interface ISprintableItem {
    CSprintItem getSprintItem();
    void moveSprintItemToSprint(CSprint sprint);
}

// Entity opts-in
public class CActivity extends CProjectItem<CActivity> 
        implements ISprintableItem {
    @OneToOne(mappedBy = "activity")
    private CSprintItem sprintItem;  // Composition, not inheritance
}
```

### Lazy Loading (CRITICAL)
Entities from grids are often detached. ALWAYS refresh before accessing lazy fields:

```java
protected void on_grid_selected(T entity) {
    // Refresh to get managed entity
    if (entity != null && entity.getId() != null) {
        entity = service.getById(entity.getId()).orElse(entity);
    }
    // Now safe to access lazy fields
}
```

Graceful fallback:
```java
try {
    return entity.getValidNextStatuses();  // May fail if detached
} catch (LazyInitializationException e) {
    return statusService.findAll();  // Fallback
}
```

### Story Points & Progress
Rules:
1. Always visible (show "0 SP" if null)
2. Click to edit
3. Auto-save on blur/enter, cancel on escape
4. Refresh column totals after save

### Multi-Value Persistence
For components with multiple state values:

```java
public class CKanbanBoard implements IHasMultiValuePersistence {
    public CKanbanBoard() {
        persist_enable("kanbanBoard_project123");
        persist_getValue("selectedLine").ifPresent(this::selectLine);
    }
    
    protected void on_line_changed(Long lineId) {
        persist_setValue("selectedLine", lineId.toString());
    }
}
```

## Testing Requirements (2026-01)

### Grid Filter Tests
```bash
./run-playwright-tests.sh comprehensive
```

Must verify:
- ‚úÖ Entity type filter works
- ‚úÖ Status filter works
- ‚úÖ Assigned to filter works
- ‚úÖ Search filter works
- ‚úÖ Clear resets ALL filters
- ‚úÖ Screenshots captured

### Story Point Tests
Must verify:
- ‚úÖ Always visible (even when 0)
- ‚úÖ Click opens editor
- ‚úÖ Enter/blur saves
- ‚úÖ Escape cancels
- ‚úÖ Column totals update

### Lazy Loading Tests
```java
@Test
void testDetachedEntity() {
    // Create, save, detach entity
    // Verify toolbar handles gracefully
    assertDoesNotThrow(() -> toolbar.update(detached));
}
```

## üìö Documentation Hierarchy (MANDATORY ORDER)

**ALWAYS FOLLOW THIS ORDER:**

### 1Ô∏è‚É£ PRIMARY (Always Start Here)
```
docs/DERBENT_CODING_MASTER_GUIDE.md
```
- 11 comprehensive sections
- 176 verification checkboxes
- All patterns consolidated
- Single source of truth

### 2Ô∏è‚É£ ARCHITECTURE (Detailed Patterns)
- `docs/architecture/NEW_ENTITY_COMPLETE_CHECKLIST.md` - Complete entity workflow
- `docs/architecture/ENTITY_INHERITANCE_AND_DESIGN_PATTERNS.md` - Inheritance patterns
- `docs/architecture/LAZY_LOADING_BEST_PRACTICES.md` - Lazy loading patterns
- `docs/architecture/CHILD_ENTITY_PATTERNS.md` - Master-detail patterns

### 3Ô∏è‚É£ DEVELOPMENT (Workflows)
- `docs/development/copilot-guidelines.md` - AI agent guidelines
- `docs/development/component-coding-standards.md` - Component standards
- `docs/development/calculated-fields-pattern.md` - Calculated fields
- `docs/development/multi-value-persistence-pattern.md` - State persistence
- `docs/development/workflow-status-change-pattern.md` - Workflow patterns

### 4Ô∏è‚É£ IMPLEMENTATION (Feature Patterns)
- `docs/implementation/WORKFLOW_ENTITY_PATTERN.md` - Workflow entities
- `docs/implementation/drag-drop-unified-pattern.md` - Drag & drop
- `docs/implementation/CRUD-Operations-Guide.md` - CRUD operations
- `docs/implementation/Grid-Selection-After-Save-Pattern.md` - Grid patterns

### 5Ô∏è‚É£ TESTING (Test Strategies)
- `docs/testing/PLAYWRIGHT_USAGE.md` - Playwright tests
- `docs/testing/RECENT_FEATURES_CRUD_TEST_PATTERNS.md` - CRUD test patterns
- `docs/testing/comprehensive-page-testing.md` - Page testing

### 6Ô∏è‚É£ PROJECT INFO
- `README.md` - Project overview
- `AGENTS.md` - AI agent guidelines
- `TESTING_RULES.md` - Testing standards

## üö´ DEPRECATED DOCUMENTATION (DO NOT USE)

**ARCHIVED**: The following docs are DEPRECATED and archived:
- `docs/archive/deprecated-2026-01/` (120+ old files)
- OLD: `coding-standards.md` ‚Üí USE: `DERBENT_CODING_MASTER_GUIDE.md`
- OLD: `service-layer-patterns.md` ‚Üí USE: `DERBENT_CODING_MASTER_GUIDE.md`
- OLD: Individual architecture docs ‚Üí USE: `DERBENT_CODING_MASTER_GUIDE.md`

**RULE**: If a document is in `docs/archive/`, DO NOT reference it for new code.

## ‚ö†Ô∏è ENFORCEMENT RULES

**BEFORE starting ANY coding task:**
1. ‚úÖ Read `docs/DERBENT_CODING_MASTER_GUIDE.md` relevant section
2. ‚úÖ Use entity decision tree (Section 2.1) for entity work
3. ‚úÖ Check Common Pitfalls (Section 10) to avoid mistakes
4. ‚úÖ Follow complete checklist (Section 2-9) for new entities

**DURING coding:**
1. ‚úÖ Reference master guide for patterns
2. ‚úÖ Follow naming conventions (typeName, on_xxx, create_xxx)
3. ‚úÖ Use C-prefixed components (NEVER raw Vaadin)
4. ‚úÖ Apply stateless service patterns

**AFTER coding:**
1. ‚úÖ Verify against checklist (Section 1 Quick Start)
2. ‚úÖ Check Section 10 (Common Pitfalls) to ensure no mistakes
3. ‚úÖ Run build: `mvn clean compile`
4. ‚úÖ Run tests: `./run-playwright-tests.sh menu`
5. ‚úÖ Apply formatting (eclipse-formatter.xml in IDE)

## üéì LESSONS LEARNED (MANDATORY)

**Read these to understand WHY patterns exist:**
- `docs/LESSONS_LEARNED_TEST_MODULE_2026-01.md` - What we missed and why
- `docs/DERBENT_CODING_MASTER_GUIDE.md` Section 11 - Lessons Learned

**Common Mistakes from Test Module (NEVER REPEAT):**
1. ‚ùå Type entities don't have createdBy field
2. ‚ùå Missing JOIN FETCH for attachments/comments
3. ‚ùå Child entities still need services
4. ‚ùå Missing CDataInitializer registration
5. ‚ùå No ORDER BY in queries
6. ‚ùå User state in service (multi-user violation)
7. ‚ùå Missing updateLastModified() in setters
8. ‚ùå Missing entity constants (5 mandatory)
9. ‚ùå Wrong base class selection
10. ‚ùå Unverified @AMetaData references

## üìä DOCUMENTATION STATS

**Active Documentation:**
- Total files: 80 essential documents
- Primary reference: 1 master guide (49KB)
- Architecture patterns: 5 files
- Development guides: 8 files
- Implementation patterns: 10 files
- Testing guides: 8 files

**Archived Documentation:**
- Deprecated files: 120+ (in docs/archive/deprecated-2026-01/)
- DO NOT USE for new code

## ‚úÖ MANDATORY VERIFICATION

**Every code change MUST:**
1. ‚úÖ Follow patterns from `DERBENT_CODING_MASTER_GUIDE.md`
2. ‚úÖ Pass all 176 checkboxes (for new entities)
3. ‚úÖ Avoid all 10 common pitfalls
4. ‚úÖ Compile successfully
5. ‚úÖ Pass relevant tests
